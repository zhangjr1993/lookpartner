import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:http/http.dart' as http;

class MbtiService {
  static const String _personalityKey = 'mbti_personality_result_v2';
  static const String _zhipuApiKey = 'YOUR_ZHIPU_API_KEY'; // 需要替换为实际的API密钥
  static const String _zhipuApiUrl = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';

  // 保存性格测试结果
  static Future<bool> savePersonalityResult(String personality) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString(_personalityKey, personality);
      return true;
    } catch (e) {
      print('保存MBTI结果失败: $e');
      return false;
    }
  }

  // 获取保存的性格测试结果
  static Future<String?> getPersonalityResult() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      return prefs.getString(_personalityKey);
    } catch (e) {
      print('获取MBTI结果失败: $e');
      return null;
    }
  }

  // 调用智普AI分析性格
  static Future<String> analyzePersonality(String personality) async {
    try {
      // 构建分析提示词
      final prompt = _buildAnalysisPrompt(personality);
      
      // 调用智普AI API
      final response = await http.post(
        Uri.parse(_zhipuApiUrl),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $_zhipuApiKey',
        },
        body: jsonEncode({
          'model': 'glm-4',
          'messages': [
            {
              'role': 'user',
              'content': prompt,
            }
          ],
          'temperature': 0.7,
          'max_tokens': 1000,
        }),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        return data['choices'][0]['message']['content'] ?? '分析失败';
      } else {
        // 如果API调用失败，返回本地分析结果
        return _getLocalAnalysis(personality);
      }
    } catch (e) {
      print('AI分析失败: $e');
      // 返回本地分析结果作为备选
      return _getLocalAnalysis(personality);
    }
  }

  // 构建分析提示词
  static String _buildAnalysisPrompt(String personality) {
    return '''
请分析MBTI性格类型 $personality 的特点，包括：

1. 性格优势：
- 在工作和学习中的优势
- 人际关系中的优势
- 个人发展中的优势

2. 潜在挑战：
- 可能遇到的困难
- 需要改进的方面
- 压力下的表现

3. 形成因素：
- 先天因素
- 后天环境影响
- 成长经历的作用

4. 发展建议：
- 如何发挥优势
- 如何克服挑战
- 个人成长建议

请用中文回答，语言要通俗易懂，内容要具体实用。
''';
  }

  // 本地分析结果（作为API调用失败时的备选）
  static String _getLocalAnalysis(String personality) {
    final analysisMap = {
      'INTJ': '''
**INTJ 建筑师型人格分析**

**性格优势：**
- 战略思维能力强，善于制定长期计划
- 独立思考，不盲从权威
- 追求完美，对工作质量要求高
- 逻辑分析能力强，善于解决复杂问题

**潜在挑战：**
- 可能显得过于理性，缺乏情感表达
- 对他人要求过高，容易产生冲突
- 不善于处理人际关系中的情感问题
- 可能过于固执，不愿意妥协

**形成因素：**
- 先天：大脑前额叶发达，逻辑思维能力强
- 后天：成长环境强调独立思考和成就导向
- 经历：可能经历过需要独立解决问题的成长环境

**发展建议：**
- 学会表达情感，增强人际交往能力
- 培养耐心，学会倾听他人意见
- 在保持高标准的同时，学会适当妥协
- 多参与团队活动，提升协作能力
''',
      'INTP': '''
**INTP 逻辑学家型人格分析**

**性格优势：**
- 创新思维能力强，善于提出新想法
- 逻辑分析能力出色，善于解决理论问题
- 好奇心强，喜欢探索未知领域
- 独立思考，不受传统观念束缚

**潜在挑战：**
- 可能过于理论化，忽视实践应用
- 社交能力相对较弱，人际关系简单
- 可能缺乏执行力，难以将想法付诸实践
- 对细节关注不够，容易出错

**形成因素：**
- 先天：大脑颞叶发达，逻辑推理能力强
- 后天：成长环境鼓励独立思考和探索
- 经历：可能经历过需要创新思维的学习环境

**发展建议：**
- 将理论知识与实践相结合
- 提升社交技能，扩大人际网络
- 培养执行力，学会将想法转化为行动
- 注意细节，提高工作质量
''',
      'ENTJ': '''
**ENTJ 指挥官型人格分析**

**性格优势：**
- 领导能力强，善于组织和指挥
- 决策果断，执行力强
- 目标导向明确，追求效率
- 战略思维能力强，善于制定计划

**潜在挑战：**
- 可能过于强势，忽视他人感受
- 对他人要求过高，容易产生压力
- 可能缺乏耐心，不愿意等待
- 情感表达不足，人际关系紧张

**形成因素：**
- 先天：大脑前额叶和杏仁核发达，决策和情绪控制能力强
- 后天：成长环境强调成就和领导力
- 经历：可能经历过需要承担责任的成长环境

**发展建议：**
- 学会倾听他人意见，增强团队合作
- 培养耐心，学会等待和包容
- 增强情感表达，改善人际关系
- 在追求效率的同时，关注他人感受
''',
      'ENTP': '''
**ENTP 辩论家型人格分析**

**性格优势：**
- 创新思维能力强，善于提出新观点
- 适应能力强，善于应对变化
- 沟通能力强，善于说服他人
- 思维敏捷，反应速度快

**潜在挑战：**
- 可能过于善变，缺乏稳定性
- 可能过于好辩，容易引起冲突
- 可能缺乏耐心，难以坚持长期目标
- 可能过于理想化，忽视现实限制

**形成因素：**
- 先天：大脑前额叶和颞叶发达，创新和语言能力强
- 后天：成长环境鼓励创新和表达
- 经历：可能经历过需要快速适应变化的环境

**发展建议：**
- 培养稳定性，学会坚持长期目标
- 控制辩论欲望，学会和谐沟通
- 增强耐心，学会深入思考
- 在创新的同时，考虑现实可行性
''',
      'INFJ': '''
**INFJ 提倡者型人格分析**

**性格优势：**
- 洞察力强，善于理解他人内心
- 同理心强，善于关心他人
- 理想主义，追求有意义的人生
- 创造力强，善于表达内心世界

**潜在挑战：**
- 可能过于理想化，难以接受现实
- 情感敏感，容易受到伤害
- 可能过于内向，不善于表达自己
- 可能过于完美主义，给自己太大压力

**形成因素：**
- 先天：大脑边缘系统发达，情感和直觉能力强
- 后天：成长环境强调情感和价值观
- 经历：可能经历过需要深度思考的成长环境

**发展建议：**
- 学会接受现实，平衡理想与现实
- 增强心理韧性，学会处理情感
- 提升表达能力，学会分享内心想法
- 在追求完美的同时，学会放松自己
''',
      'INFP': '''
**INFP 调停者型人格分析**

**性格优势：**
- 同理心强，善于理解他人感受
- 创造力强，善于表达内心世界
- 价值观明确，追求内心和谐
- 适应能力强，善于处理复杂情感

**潜在挑战：**
- 可能过于敏感，容易受到外界影响
- 可能过于理想化，难以面对现实
- 可能缺乏决断力，难以做出决定
- 可能过于内向，不善于社交

**形成因素：**
- 先天：大脑边缘系统和颞叶发达，情感和创造力强
- 后天：成长环境强调情感和价值观
- 经历：可能经历过需要深度情感体验的环境

**发展建议：**
- 增强心理韧性，学会处理外界压力
- 学会面对现实，平衡理想与实际
- 提升决断力，学会快速做出决定
- 增强社交能力，学会与他人互动
''',
      'ENFJ': '''
**ENFJ 主人公型人格分析**

**性格优势：**
- 领导能力强，善于激励他人
- 同理心强，善于理解他人需求
- 沟通能力强，善于建立关系
- 组织能力强，善于协调团队

**潜在挑战：**
- 可能过于关注他人，忽视自己需求
- 可能过于理想化，难以接受批评
- 可能过于情绪化，影响决策质量
- 可能过于依赖他人认可

**形成因素：**
- 先天：大脑前额叶和边缘系统发达，领导力和情感能力强
- 后天：成长环境强调人际关系和领导力
- 经历：可能经历过需要照顾他人的成长环境

**发展建议：**
- 学会关注自己需求，保持自我边界
- 增强心理韧性，学会接受批评
- 提升理性思维，平衡情感与逻辑
- 培养独立性，不过度依赖他人认可
''',
      'ENFP': '''
**ENFP 竞选者型人格分析**

**性格优势：**
- 热情开朗，善于激励他人
- 创造力强，善于提出新想法
- 适应能力强，善于应对变化
- 同理心强，善于理解他人

**潜在挑战：**
- 可能过于善变，缺乏稳定性
- 可能过于理想化，难以坚持
- 可能过于情绪化，影响判断
- 可能过于依赖他人认可

**形成因素：**
- 先天：大脑前额叶和边缘系统发达，创新和情感能力强
- 后天：成长环境鼓励创新和表达
- 经历：可能经历过需要快速适应变化的环境

**发展建议：**
- 培养稳定性，学会坚持长期目标
- 学会面对现实，平衡理想与实际
- 提升理性思维，平衡情感与逻辑
- 培养独立性，不过度依赖他人认可
''',
      'ISTJ': '''
**ISTJ 物流师型人格分析**

**性格优势：**
- 责任心强，善于完成任务
- 组织能力强，善于管理细节
- 可靠性高，值得信赖
- 实践能力强，善于执行计划

**潜在挑战：**
- 可能过于保守，缺乏创新
- 可能过于固执，难以适应变化
- 可能过于注重细节，忽视大局
- 可能过于严肃，缺乏灵活性

**形成因素：**
- 先天：大脑顶叶和枕叶发达，空间和细节处理能力强
- 后天：成长环境强调责任和秩序
- 经历：可能经历过需要严格执行的环境

**发展建议：**
- 培养创新思维，学会接受新事物
- 增强灵活性，学会适应变化
- 提升大局观，学会把握重点
- 增加幽默感，学会放松自己
''',
      'ISFJ': '''
**ISFJ 守卫者型人格分析**

**性格优势：**
- 责任心强，善于照顾他人
- 细心周到，善于关注细节
- 忠诚可靠，值得信赖
- 实践能力强，善于执行任务

**潜在挑战：**
- 可能过于保守，缺乏冒险精神
- 可能过于敏感，容易受到伤害
- 可能过于依赖他人认可
- 可能过于注重细节，忽视大局

**形成因素：**
- 先天：大脑顶叶和边缘系统发达，空间和情感处理能力强
- 后天：成长环境强调责任和关怀
- 经历：可能经历过需要照顾他人的环境

**发展建议：**
- 培养冒险精神，学会尝试新事物
- 增强心理韧性，学会处理情感
- 培养独立性，不过度依赖他人认可
- 提升大局观，学会把握重点
''',
      'ESTJ': '''
**ESTJ 总经理型人格分析**

**性格优势：**
- 领导能力强，善于组织管理
- 执行力强，善于完成任务
- 责任心强，值得信赖
- 决策果断，善于处理问题

**潜在挑战：**
- 可能过于强势，忽视他人感受
- 可能过于保守，缺乏创新
- 可能过于注重效率，忽视人际关系
- 可能过于固执，难以接受新观点

**形成因素：**
- 先天：大脑前额叶和顶叶发达，决策和空间处理能力强
- 后天：成长环境强调领导和责任
- 经历：可能经历过需要承担管理责任的环境

**发展建议：**
- 学会倾听他人意见，增强团队合作
- 培养创新思维，学会接受新事物
- 关注人际关系，平衡效率与和谐
- 增强灵活性，学会接受不同观点
''',
      'ESFJ': '''
**ESFJ 执政官型人格分析**

**性格优势：**
- 社交能力强，善于建立关系
- 组织能力强，善于协调团队
- 同理心强，善于关心他人
- 责任心强，善于完成任务

**潜在挑战：**
- 可能过于依赖他人认可
- 可能过于传统，缺乏创新
- 可能过于情绪化，影响判断
- 可能过于注重和谐，忽视问题

**形成因素：**
- 先天：大脑前额叶和边缘系统发达，社交和情感能力强
- 后天：成长环境强调人际关系和和谐
- 经历：可能经历过需要协调人际关系的环境

**发展建议：**
- 培养独立性，不过度依赖他人认可
- 培养创新思维，学会接受新事物
- 提升理性思维，平衡情感与逻辑
- 学会面对问题，不回避冲突
''',
      'ISTP': '''
**ISTP 鉴赏家型人格分析**

**性格优势：**
- 实践能力强，善于解决技术问题
- 适应能力强，善于应对变化
- 观察力强，善于发现细节
- 冷静理性，善于处理危机

**潜在挑战：**
- 可能过于独立，不善于合作
- 可能过于理性，缺乏情感表达
- 可能过于随性，缺乏计划性
- 可能过于内向，不善于社交

**形成因素：**
- 先天：大脑顶叶和颞叶发达，空间和逻辑处理能力强
- 后天：成长环境强调独立和实用
- 经历：可能经历过需要独立解决问题的环境

**发展建议：**
- 增强团队合作能力，学会与他人协作
- 学会表达情感，增强人际交往
- 培养计划性，学会制定目标
- 提升社交能力，学会与他人互动
''',
      'ISFP': '''
**ISFP 探险家型人格分析**

**性格优势：**
- 艺术感强，善于创造美
- 同理心强，善于理解他人
- 适应能力强，善于应对变化
- 实践能力强，善于动手操作

**潜在挑战：**
- 可能过于敏感，容易受到伤害
- 可能过于随性，缺乏计划性
- 可能过于内向，不善于表达
- 可能过于理想化，难以面对现实

**形成因素：**
- 先天：大脑顶叶和边缘系统发达，空间和情感处理能力强
- 后天：成长环境强调艺术和情感
- 经历：可能经历过需要创造和表达的环境

**发展建议：**
- 增强心理韧性，学会处理情感
- 培养计划性，学会制定目标
- 提升表达能力，学会分享内心想法
- 学会面对现实，平衡理想与实际
''',
      'ESTP': '''
**ESTP 企业家型人格分析**

**性格优势：**
- 行动力强，善于快速决策
- 适应能力强，善于应对变化
- 实践能力强，善于解决问题
- 社交能力强，善于建立关系

**潜在挑战：**
- 可能过于冲动，缺乏深思熟虑
- 可能过于随性，缺乏计划性
- 可能过于注重当下，忽视长远
- 可能过于冒险，承担过多风险

**形成因素：**
- 先天：大脑前额叶和顶叶发达，决策和空间处理能力强
- 后天：成长环境鼓励冒险和行动
- 经历：可能经历过需要快速反应的环境

**发展建议：**
- 培养深思熟虑的习惯，学会分析后果
- 增强计划性，学会制定长期目标
- 提升长远思维，学会考虑未来
- 控制冒险倾向，学会评估风险
''',
      'ESFP': '''
**ESFP 表演者型人格分析**

**性格优势：**
- 热情开朗，善于激励他人
- 社交能力强，善于建立关系
- 适应能力强，善于应对变化
- 同理心强，善于理解他人

**潜在挑战：**
- 可能过于情绪化，影响判断
- 可能过于随性，缺乏计划性
- 可能过于依赖他人认可
- 可能过于注重当下，忽视长远

**形成因素：**
- 先天：大脑前额叶和边缘系统发达，社交和情感能力强
- 后天：成长环境鼓励表达和社交
- 经历：可能经历过需要快速适应变化的环境

**发展建议：**
- 提升理性思维，平衡情感与逻辑
- 培养计划性，学会制定目标
- 培养独立性，不过度依赖他人认可
- 提升长远思维，学会考虑未来
''',
    };

    return analysisMap[personality] ?? '''
**$personality 性格类型分析**

**性格特点：**
这是一个独特的性格类型，具有自己的优势和特点。

**发展建议：**
- 了解自己的优势，充分发挥潜能
- 认识自己的挑战，积极改进不足
- 保持开放心态，持续学习和成长
- 找到适合自己的发展道路

**温馨提示：**
MBTI测试结果仅供参考，每个人的性格都是独特的，重要的是了解自己并不断成长。
''';
  }
}

